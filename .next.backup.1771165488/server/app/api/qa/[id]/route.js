"use strict";(()=>{var a={};a.id=1078,a.ids=[1078],a.modules={261:a=>{a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:a=>{a.exports=require("querystring")},12412:a=>{a.exports=require("assert")},19121:a=>{a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},21820:a=>{a.exports=require("os")},27910:a=>{a.exports=require("stream")},28354:a=>{a.exports=require("util")},29021:a=>{a.exports=require("fs")},29294:a=>{a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:a=>{a.exports=require("path")},34631:a=>{a.exports=require("tls")},37903:(a,b,c)=>{c.r(b),c.d(b,{handler:()=>$,patchFetch:()=>Z,routeModule:()=>V,serverHooks:()=>Y,workAsyncStorage:()=>W,workUnitAsyncStorage:()=>X});var d={};c.r(d),c.d(d,{GET:()=>T,POST:()=>U});var e=c(95736),f=c(9117),g=c(4044),h=c(39326),i=c(32324),j=c(261),k=c(54290),l=c(85328),m=c(38928),n=c(46595),o=c(3421),p=c(17679),q=c(41681),r=c(63446),s=c(86439),t=c(51356),u=c(10641),v=c(68941),w=c(50071),x=c(79725);let y=a=>({id:String(a.id??""),podcastId:String(a.podcastId??""),userId:a.userId||null,question:String(a.question??""),answer:String(a.answer??""),suggestedQuestion:!!a.suggestedQuestion,createdAt:String(a.createdAt??"")});async function z(){await (0,x.ll)`
    CREATE TABLE IF NOT EXISTS qa_messages (
      id TEXT PRIMARY KEY,
      podcast_id TEXT NOT NULL REFERENCES podcasts(id) ON DELETE CASCADE,
      user_id TEXT REFERENCES users(id) ON DELETE SET NULL,
      question TEXT NOT NULL,
      answer TEXT NOT NULL,
      suggested_question BOOLEAN DEFAULT FALSE,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )
  `,await (0,x.ll)`
    CREATE INDEX IF NOT EXISTS idx_qa_messages_podcast_created_at
    ON qa_messages (podcast_id, created_at DESC)
  `}async function A(a){try{await z();let b=(0,w.Ak)(),c=await (0,x.ll)`
      INSERT INTO qa_messages (
        id,
        podcast_id,
        user_id,
        question,
        answer,
        suggested_question
      )
      VALUES (
        ${b},
        ${a.podcastId},
        ${a.userId??null},
        ${a.question},
        ${a.answer},
        ${!!a.suggestedQuestion}
      )
      RETURNING
        id,
        podcast_id as "podcastId",
        user_id as "userId",
        question,
        answer,
        suggested_question as "suggestedQuestion",
        created_at as "createdAt"
    `;if(0===c.rows.length)return{success:!1,error:"Failed to save QA message"};return{success:!0,data:y(c.rows[0])}}catch(a){return console.error("saveQaMessage failed:",a),{success:!1,error:a instanceof Error?a.message:String(a)}}}async function B(a,b=30){try{await z();let c=Number.isFinite(b)?Math.max(1,Math.min(200,Math.floor(b))):30,d=await (0,x.ll)`
      SELECT
        id,
        podcast_id as "podcastId",
        user_id as "userId",
        question,
        answer,
        suggested_question as "suggestedQuestion",
        created_at as "createdAt"
      FROM qa_messages
      WHERE podcast_id = ${a}
      ORDER BY created_at ASC
      LIMIT ${c}
    `;return{success:!0,data:d.rows.map(a=>y(a))}}catch(a){return console.error("getQaMessages failed:",a),{success:!1,error:a instanceof Error?a.message:String(a)}}}var C=c(1093),D=c(66147),E=c(1434),F=c(42154);let G=process.env.OPENROUTER_QA_MODEL||E.a.MODEL,H=Math.max(4,Math.min(12,Number.parseInt(process.env.QA_MAX_RETRIEVED_CHUNKS||"8",10))),I=Math.max(1e4,Number.parseInt(process.env.QA_MODEL_TIMEOUT_MS||"45000",10)||45e3),J=Math.max(0,Number.parseInt(process.env.QA_MODEL_MAX_RETRIES||"1",10)||1),K=Math.max(0,Number.parseInt(process.env.QA_MODEL_RETRY_DELAY_MS||"800",10)||800),L=new Set(["the","and","that","this","what","with","from","about","have","will","would","could","should","which","where","when","how","why","are","is","for","you","your","podcast","episode","into","than","then","there","their","they","them","been","were","was","can","did","does","any","more","less","just","also"]),M=new Set(["这个","那个","哪些","什么","如何","为什么","请问","一下","里面","还有","关于","可以","是否","是不是","有没有","总结","翻译","全文","重点"]);function N(a){return"string"!=typeof a?"":a.replace(/\r\n/g,"\n").trim()}function O(a,b,c){if(!a)return"";let d=N(a);if(d.length<=c)return d;let e=function(a){let b=a.toLowerCase().match(/[a-z0-9][a-z0-9_-]{2,}/g)||[],c=a.match(/[\u4e00-\u9fff]{2,6}/g)||[],d=new Set;for(let a of b)L.has(a)||d.add(a);for(let a of c)M.has(a)||d.add(a);return Array.from(d).slice(0,12)}(b);if(0===e.length)return d.slice(0,c);let f=d.split("\n"),g=[];for(let a=0;a<f.length;a++){let b=f[a].toLowerCase();e.some(a=>b.includes(a.toLowerCase()))&&g.push(a)}if(0===g.length)return d.slice(0,c);let h=[],i=0,j=new Set;for(let a of g){let b=Math.max(0,a-2),d=Math.min(f.length,a+3),e=f.slice(b,d).join("\n").trim();if(!e||j.has(e))continue;j.add(e);let g=i+e.length+6;if(g>c)break;h.push(e),i=g}return 0===h.length?d.slice(0,c):h.join("\n\n---\n\n")}async function P(a){if(!a)return"";try{let b=await fetch(a);if(!b.ok)return"";let c=await b.text();return N(c)}catch{return""}}function Q(a){return a.map((a,b)=>{let c=(0,F.mE)(a);return[`### Evidence ${b+1}`,`id: chunk-${a.id}`,`label: ${c}`,`score: ${a.finalScore.toFixed(4)} (semantic=${a.semanticScore.toFixed(4)}, lexical=${a.lexicalScore.toFixed(4)})`,a.content].join("\n")}).join("\n\n---\n\n")}async function R(a,b,c){let d=process.env.OPENROUTER_API_KEY;if(!d)throw Error("OPENROUTER_API_KEY is not configured");let e="hybrid"===c?"你是播客问答助手。你只能基于提供的证据回答，不要编造。请用中文输出，结构为：1) 直接答案；2) 依据要点（最多3条）。每条依据后追加对应证据 id（格式例如：chunk-12）。如果证据只支持“间接提及”，请明确写“属于间接提及，未直接下结论”。如果证据不足，请明确写“在当前上下文中未找到明确依据”。":"你是播客问答助手。只能基于提供的上下文回答，不要编造。请用中文输出，结构为：1) 直接答案；2) 依据要点（最多3条）。如果上下文不足，请明确写“在当前上下文中未找到明确依据”。",f=null;for(let c=0;c<=J;c+=1){let g=new AbortController,h=setTimeout(()=>g.abort(),I);try{let f=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`,"HTTP-Referer":process.env.NEXTAUTH_URL?process.env.NEXTAUTH_URL:process.env.VERCEL_URL?`https://${process.env.VERCEL_URL}`:"http://localhost:3000","X-Title":"PodSum.cc QA"},body:JSON.stringify({model:G,temperature:.2,max_tokens:1800,messages:[{role:"system",content:e},{role:"user",content:`问题：${a}

上下文：
${b}`}]}),signal:g.signal});if(!f.ok){let a=await f.text(),b=Error(`QA model request failed: ${f.status} ${a}`);if((429===f.status||f.status>=500)&&c<J){await new Promise(a=>setTimeout(a,K));continue}throw b}let h=await f.json(),i=h.choices?.[0]?.message?.content;if(!i||"string"!=typeof i)throw Error("No answer generated");return i.trim()}catch(a){if(f=a instanceof Error&&"AbortError"===a.name?Error(`QA model request timed out after ${I}ms`):a instanceof Error?a:Error(String(a)),c<J){await new Promise(a=>setTimeout(a,K));continue}throw f}finally{clearTimeout(h)}}throw f||Error("QA model request failed")}async function S(a){let b=await (0,v.rL)(a);if(!b.success)return{success:!1,response:u.NextResponse.json({success:!1,error:"Podcast not found"},{status:404})};let c=b.data,d=await (0,C.getServerSession)(D.N),e=d?.user?.id||null;if(!c.isPublic){if(!e)return{success:!1,response:u.NextResponse.json({success:!1,error:"Authentication required"},{status:401})};if(!(await (0,v.Pr)(a,e)).success)return{success:!1,response:u.NextResponse.json({success:!1,error:"Access denied"},{status:403})}}return{success:!0,podcast:c,userId:e}}async function T(a,b){try{let{id:c}=await b.params;if(!c)return u.NextResponse.json({success:!1,error:"Missing ID parameter"},{status:400});let d=await S(c);if(!d.success)return d.response;let e=a.nextUrl.searchParams.get("limit"),f=e?Number(e):30,g=await B(c,Number.isFinite(f)?f:30);if(!g.success)return u.NextResponse.json({success:!1,error:g.error||"Failed to fetch QA history"},{status:500});return u.NextResponse.json({success:!0,data:{messages:g.data||[]}})}catch(a){return console.error("QA history API failed:",a),u.NextResponse.json({success:!1,error:a instanceof Error?a.message:String(a)},{status:500})}}async function U(a,b){try{let{id:c}=await b.params;if(!c)return u.NextResponse.json({success:!1,error:"Missing ID parameter"},{status:400});let d=await S(c);if(!d.success)return d.response;let e=await a.json(),f=N(e?.question);if(!f)return u.NextResponse.json({success:!1,error:"Question is required"},{status:400});if(f.length>1e3)return u.NextResponse.json({success:!1,error:"Question is too long (max 1000 chars)"},{status:400});let g=await (0,v.VM)(c);if(!g.success)return u.NextResponse.json({success:!1,error:"Analysis is not ready yet. Please wait until processing finishes."},{status:409});let h=g.data||{},i=await (0,F.pD)(c,f,H),j="",k="hybrid";if(i.length>0)j=Q(i);else{let a=await P(d.podcast.blobUrl),b=await (0,F.Es)({podcastId:c,summary:h.summary,translation:h.translation,highlights:h.highlights,transcriptSrt:a});b.success&&b.chunkCount>0&&(i=await (0,F.pD)(c,f,H)),i.length>0?j=Q(i):(j=function(a,b,c){let d=O(N(b.summary),a,12e3),e=O(N(b.translation),a,35e3),f=O(N(b.highlights),a,15e3);return["### Summary",d||"未提供","\n### Translation",e||"未提供","\n### Highlights",f||"未提供","\n### Transcript Snippets",O(c,a,3e4)||"未提供"].join("\n")}(f,h,a),k="legacy")}let l=await R(f,j,k),m=await A({podcastId:c,userId:d.userId,question:f,answer:l,suggestedQuestion:!!e?.suggested});if(!m.success)return u.NextResponse.json({success:!1,error:m.error||"Failed to save QA result"},{status:500});return u.NextResponse.json({success:!0,data:m.data})}catch(a){return console.error("QA ask API failed:",a),u.NextResponse.json({success:!1,error:a instanceof Error?a.message:String(a)},{status:500})}}let V=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/qa/[id]/route",pathname:"/api/qa/[id]",filename:"route",bundlePath:"app/api/qa/[id]/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/chenzixin/projects/PodcastSummarizer/app/api/qa/[id]/route.ts",nextConfigOutput:"",userland:d}),{workAsyncStorage:W,workUnitAsyncStorage:X,serverHooks:Y}=V;function Z(){return(0,g.patchFetch)({workAsyncStorage:W,workUnitAsyncStorage:X})}async function $(a,b,c){var d;let e="/api/qa/[id]/route";"/index"===e&&(e="/");let g=await V.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,D=(0,j.normalizeAppPath)(e),E=!!(y.dynamicRoutes[D]||y.routes[C]);if(E&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let F=null;!E||V.isDev||x||(F="/index"===(F=C)?"/":F);let G=!0===V.isDev||!E,H=E&&!G,I=a.method||"GET",J=(0,i.getTracer)(),K=J.getActiveScopeSpan(),L={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:G,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:H,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>V.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},M=new k.NodeNextRequest(a),N=new k.NodeNextResponse(b),O=l.NextRequestAdapter.fromNodeNextRequest(M,(0,l.signalFromNodeResponse)(b));try{let d=async c=>V.handle(O,L).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=J.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${I} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${I} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=L.renderOpts.fetchMetrics;let i=L.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=L.renderOpts.collectedTags;if(!E)return await (0,o.I)(M,N,e,L.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,d=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await V.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})},z),b}},l=await V.handleResponse({req:a,nextConfig:w,cacheKey:F,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!E)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&E||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(M,N,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};K?await g(K):await J.withPropagatedContext(a.headers,()=>J.trace(m.BaseServerSpan.handleRequest,{spanName:`${I} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":I,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await V.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})}),E)throw b;return await (0,o.I)(M,N,new Response(null,{status:500})),null}}},44870:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:a=>{a.exports=require("crypto")},55591:a=>{a.exports=require("https")},63033:a=>{a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:a=>{a.exports=require("zlib")},77598:a=>{a.exports=require("node:crypto")},79428:a=>{a.exports=require("buffer")},79551:a=>{a.exports=require("url")},81630:a=>{a.exports=require("http")},86439:a=>{a.exports=require("next/dist/shared/lib/no-fallback-error.external")},91645:a=>{a.exports=require("net")},94735:a=>{a.exports=require("events")}};var b=require("../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[4996,1692,9725,7028,5106,7146,4735],()=>b(b.s=37903));module.exports=c})();