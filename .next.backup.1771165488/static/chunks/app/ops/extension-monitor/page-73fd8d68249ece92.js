(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6176],{63:(e,s,t)=>{"use strict";var a=t(7260);t.o(a,"useParams")&&t.d(s,{useParams:function(){return a.useParams}}),t.o(a,"useRouter")&&t.d(s,{useRouter:function(){return a.useRouter}}),t.o(a,"useSearchParams")&&t.d(s,{useSearchParams:function(){return a.useSearchParams}})},3636:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>x});var a=t(5155),l=t(2115),r=t(6489),n=t(63),d=t(2619),i=t.n(d),c=t(5239);function o(e){let s=new Date(e);return Number.isFinite(s.getTime())?s.toLocaleString():"-"}function x(){var e,s,t;let{data:d,status:x}=(0,r.useSession)(),u=(0,n.useRouter)(),[m,p]=(0,l.useState)(""),[h,j]=(0,l.useState)(""),[b,v]=(0,l.useState)(""),[g,N]=(0,l.useState)(""),[f,y]=(0,l.useState)(""),[k,S]=(0,l.useState)(1),[w,C]=(0,l.useState)(20),[E,P]=(0,l.useState)(!0),[I,R]=(0,l.useState)(!1),[q,T]=(0,l.useState)(!1),[_,M]=(0,l.useState)(null),[B,D]=(0,l.useState)([]),[H,U]=(0,l.useState)(null),[z,J]=(0,l.useState)(null),[L,O]=(0,l.useState)([]),[A,F]=(0,l.useState)(!1),[G,K]=(0,l.useState)(0),[Q,V]=(0,l.useState)(1),W=(0,l.useCallback)(async()=>{R(!0),M(null);try{let s=new URLSearchParams;s.set("page",String(k)),s.set("pageSize",String(w)),m&&s.set("path",m),h&&s.set("status",h),b.trim()&&s.set("q",b.trim()),g.trim()&&s.set("from",g.trim()),f.trim()&&s.set("to",f.trim());let t=await fetch("/api/ops/extension-monitor/tasks?".concat(s.toString())),a=await t.json();if(!t.ok||!a.success||!a.data)throw Error(a.error||"Request failed (".concat(t.status,")"));if(D(a.data.tasks||[]),K(a.data.pagination.total||0),V(a.data.pagination.totalPages||1),F(!!a.data.monitor.captureRaw),!H&&a.data.tasks.length>0&&U(a.data.tasks[0].id),H&&!a.data.tasks.find(e=>e.id===H)){var e;U((null==(e=a.data.tasks[0])?void 0:e.id)||null)}}catch(e){M(e instanceof Error?e.message:String(e)),D([]),K(0),V(1),U(null),J(null),O([])}finally{R(!1)}},[k,w,m,b,H,h,g,f]),X=(0,l.useCallback)(async e=>{if(e){T(!0);try{let s=await fetch("/api/ops/extension-monitor/tasks/".concat(encodeURIComponent(e))),t=await s.json();if(!s.ok||!t.success||!t.data)throw Error(t.error||"Request failed (".concat(s.status,")"));J(t.data.task),O(t.data.events||[]),F(!!t.data.monitor.captureRaw)}catch(e){M(e instanceof Error?e.message:String(e)),J(null),O([])}finally{T(!1)}}},[]);(0,l.useEffect)(()=>{var e;if("unauthenticated"===x)return void u.replace("/auth/signin?callbackUrl=/ops/extension-monitor");(null==d||null==(e=d.user)?void 0:e.id)&&W()},[null==d||null==(e=d.user)?void 0:e.id,x,u,W]),(0,l.useEffect)(()=>{H&&X(H)},[H,X]),(0,l.useEffect)(()=>{var e;if(!E||!(null==d||null==(e=d.user)?void 0:e.id))return;let s=setInterval(()=>{W(),H&&X(H)},5e3);return()=>clearInterval(s)},[E,X,W,H,null==d||null==(s=d.user)?void 0:s.id]);let Y=k>1,Z=k<Q,$=(0,l.useMemo)(()=>z?z.title||z.videoId||z.id:"未选择任务",[z]);return"loading"===x?(0,a.jsx)("div",{className:"min-h-screen bg-slate-900 text-white flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-sky-500 mx-auto mb-4"}),(0,a.jsx)("p",{className:"text-slate-400",children:"Loading monitor..."})]})}):"unauthenticated"===x?(0,a.jsx)("div",{className:"min-h-screen bg-slate-900 text-white flex items-center justify-center",children:(0,a.jsx)("p",{className:"text-slate-400",children:"Redirecting to sign in..."})}):(0,a.jsxs)("div",{className:"min-h-screen bg-slate-900 text-white",children:[(0,a.jsx)("header",{className:"p-4 bg-slate-800/60 backdrop-blur-md shadow-lg sticky top-0 z-10",children:(0,a.jsxs)("div",{className:"container mx-auto",children:[(0,a.jsxs)("nav",{className:"flex items-center space-x-2 text-xl mb-3",children:[(0,a.jsxs)(i(),{href:"/",className:"inline-flex items-center gap-2 text-sky-400 hover:underline font-semibold",children:[(0,a.jsx)(c.default,{src:"/podcast-summarizer-icon.svg",alt:"PodSum logo",width:22,height:22}),(0,a.jsx)("span",{children:"PodSum.cc"})]}),(0,a.jsx)("span",{className:"text-slate-400",children:"/"}),(0,a.jsx)("span",{className:"text-white font-medium",children:"Extension Monitor"})]}),(0,a.jsxs)("p",{className:"text-sm text-slate-300",children:["已登录：",(0,a.jsx)("span",{className:"text-sky-300",children:null==d||null==(t=d.user)?void 0:t.email})," \xb7 Raw 日志：",(0,a.jsx)("span",{className:A?"text-amber-300":"text-emerald-300",children:A?" 开启":" 关闭"})]})]})}),(0,a.jsxs)("main",{className:"container mx-auto p-4 space-y-4",children:[(0,a.jsxs)("section",{className:"bg-slate-800/50 border border-slate-700 rounded-lg p-4",children:[(0,a.jsxs)("div",{className:"grid md:grid-cols-6 gap-3",children:[(0,a.jsxs)("select",{value:m,onChange:e=>{p(e.target.value),S(1)},className:"bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm",children:[(0,a.jsx)("option",{value:"",children:"全部路径"}),(0,a.jsx)("option",{value:"path1",children:"Path1"}),(0,a.jsx)("option",{value:"path2",children:"Path2"})]}),(0,a.jsxs)("select",{value:h,onChange:e=>{j(e.target.value),S(1)},className:"bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm",children:[(0,a.jsx)("option",{value:"",children:"全部状态"}),(0,a.jsx)("option",{value:"received",children:"received"}),(0,a.jsx)("option",{value:"accepted",children:"accepted"}),(0,a.jsx)("option",{value:"transcribing",children:"transcribing"}),(0,a.jsx)("option",{value:"queued",children:"queued"}),(0,a.jsx)("option",{value:"processing",children:"processing"}),(0,a.jsx)("option",{value:"completed",children:"completed"}),(0,a.jsx)("option",{value:"failed",children:"failed"})]}),(0,a.jsx)("input",{value:b,onChange:e=>{v(e.target.value),S(1)},placeholder:"搜索邮箱/任务ID/trace/video...",className:"md:col-span-2 bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm"}),(0,a.jsx)("input",{type:"datetime-local",value:g,onChange:e=>{N(e.target.value),S(1)},className:"bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm"}),(0,a.jsx)("input",{type:"datetime-local",value:f,onChange:e=>{y(e.target.value),S(1)},className:"bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm"})]}),(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-3 mt-3",children:[(0,a.jsx)("button",{onClick:()=>W(),disabled:I,className:"bg-sky-600 hover:bg-sky-700 disabled:opacity-50 px-4 py-2 rounded text-sm font-medium",children:I?"刷新中...":"刷新"}),(0,a.jsxs)("label",{className:"inline-flex items-center gap-2 text-sm text-slate-300",children:[(0,a.jsx)("input",{type:"checkbox",checked:E,onChange:e=>P(e.target.checked)}),"自动刷新（5s）"]}),(0,a.jsxs)("select",{value:w,onChange:e=>{C(Number(e.target.value)),S(1)},className:"bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm",children:[(0,a.jsx)("option",{value:10,children:"10 / 页"}),(0,a.jsx)("option",{value:20,children:"20 / 页"}),(0,a.jsx)("option",{value:50,children:"50 / 页"})]}),(0,a.jsxs)("span",{className:"text-sm text-slate-400",children:["总计 ",G," 条"]})]})]}),_&&(0,a.jsx)("section",{className:"bg-red-900/40 border border-red-700 rounded-lg p-3 text-red-100 text-sm",children:_}),(0,a.jsxs)("section",{className:"grid lg:grid-cols-[1.1fr_1fr] gap-4",children:[(0,a.jsxs)("div",{className:"bg-slate-800/50 border border-slate-700 rounded-lg overflow-hidden",children:[(0,a.jsx)("div",{className:"px-4 py-3 border-b border-slate-700 text-sm text-slate-300",children:"任务列表"}),(0,a.jsx)("div",{className:"max-h-[70vh] overflow-auto",children:0===B.length?(0,a.jsx)("div",{className:"p-4 text-sm text-slate-400",children:"暂无任务"}):(0,a.jsx)("ul",{className:"divide-y divide-slate-700",children:B.map(e=>(0,a.jsxs)("li",{className:"p-3 cursor-pointer hover:bg-slate-700/30 ".concat(H===e.id?"bg-sky-900/20":""),onClick:()=>U(e.id),children:[(0,a.jsxs)("div",{className:"flex justify-between gap-3",children:[(0,a.jsxs)("div",{className:"min-w-0",children:[(0,a.jsx)("p",{className:"text-sm font-medium truncate",children:e.title||e.videoId||e.id}),(0,a.jsxs)("p",{className:"text-xs text-slate-400 truncate",children:[e.userEmail||"unknown"," \xb7 ",e.path.toUpperCase()," \xb7 ",e.stage]})]}),(0,a.jsx)("span",{className:"text-xs px-2 py-1 rounded h-fit ".concat("failed"===e.status?"bg-red-900/60 text-red-200":"completed"===e.status?"bg-emerald-900/60 text-emerald-200":"bg-slate-700 text-slate-200"),children:e.status})]}),(0,a.jsxs)("div",{className:"mt-1 text-xs text-slate-500",children:["更新于 ",o(e.updatedAt),e.lastErrorMessage?" \xb7 错误: ".concat(e.lastErrorMessage):""]})]},e.id))})}),(0,a.jsxs)("div",{className:"px-4 py-3 border-t border-slate-700 flex items-center justify-between",children:[(0,a.jsx)("button",{disabled:!Y,onClick:()=>S(e=>Math.max(1,e-1)),className:"px-3 py-1 text-sm rounded border border-slate-600 disabled:opacity-50",children:"上一页"}),(0,a.jsxs)("span",{className:"text-xs text-slate-400",children:["第 ",k," / ",Math.max(1,Q)," 页"]}),(0,a.jsx)("button",{disabled:!Z,onClick:()=>S(e=>e+1),className:"px-3 py-1 text-sm rounded border border-slate-600 disabled:opacity-50",children:"下一页"})]})]}),(0,a.jsxs)("div",{className:"bg-slate-800/50 border border-slate-700 rounded-lg overflow-hidden",children:[(0,a.jsxs)("div",{className:"px-4 py-3 border-b border-slate-700 text-sm text-slate-300",children:["任务详情 \xb7 ",$]}),q?(0,a.jsx)("div",{className:"p-4 text-sm text-slate-400",children:"加载详情中..."}):z?(0,a.jsxs)("div",{className:"max-h-[70vh] overflow-auto p-4 space-y-4",children:[(0,a.jsxs)("div",{className:"text-sm space-y-1",children:[(0,a.jsxs)("p",{children:[(0,a.jsx)("span",{className:"text-slate-400",children:"Task ID:"})," ",z.id]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("span",{className:"text-slate-400",children:"Client Task:"})," ",z.clientTaskId||"-"]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("span",{className:"text-slate-400",children:"Trace:"})," ",z.traceId||"-"]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("span",{className:"text-slate-400",children:"Transcription Job:"})," ",z.transcriptionJobId||"-"]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("span",{className:"text-slate-400",children:"Podcast ID:"})," ",z.podcastId||"-"]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("span",{className:"text-slate-400",children:"Provider Task:"})," ",z.providerTaskId||"-"]})]}),(0,a.jsxs)("div",{className:"border border-slate-700 rounded",children:[(0,a.jsx)("div",{className:"px-3 py-2 border-b border-slate-700 text-xs text-slate-300",children:"事件时间线"}),(0,a.jsx)("div",{className:"divide-y divide-slate-700",children:0===L.length?(0,a.jsx)("div",{className:"px-3 py-3 text-xs text-slate-400",children:"暂无事件"}):L.map(e=>(0,a.jsxs)("details",{className:"px-3 py-2",children:[(0,a.jsxs)("summary",{className:"cursor-pointer text-xs text-slate-200 flex items-center gap-2",children:[(0,a.jsx)("span",{className:"inline-block w-2 h-2 rounded-full ".concat("error"===e.level?"bg-red-400":"warn"===e.level?"bg-amber-400":"bg-emerald-400")}),(0,a.jsx)("span",{children:e.stage}),(0,a.jsx)("span",{className:"text-slate-400",children:o(e.createdAt)})]}),(0,a.jsxs)("div",{className:"mt-2 space-y-2",children:[(0,a.jsx)("p",{className:"text-xs text-slate-400",children:e.message||"-"}),(0,a.jsx)("pre",{className:"text-[11px] bg-slate-900 p-2 rounded overflow-auto",children:JSON.stringify({endpoint:e.endpoint,httpStatus:e.httpStatus,requestHeaders:e.requestHeaders,requestBody:e.requestBody,responseHeaders:e.responseHeaders,responseBody:e.responseBody,meta:e.meta,errorStack:e.errorStack},null,2)})]})]},e.id))})]})]}):(0,a.jsx)("div",{className:"p-4 text-sm text-slate-400",children:"请选择左侧任务"})]})]})]})]})}},9904:(e,s,t)=>{Promise.resolve().then(t.bind(t,3636))}},e=>{e.O(0,[2619,6489,5239,8441,1255,7358],()=>e(e.s=9904)),_N_E=e.O()}]);